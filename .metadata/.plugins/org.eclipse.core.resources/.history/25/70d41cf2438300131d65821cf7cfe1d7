package xoric.prism.server.control;

import java.util.ArrayList;
import java.util.List;

import xoric.prism.com.Message;
import xoric.prism.data.exceptions.PrismException;
import xoric.prism.data.types.IText_r;
import xoric.prism.server.net.ClientCore;
import xoric.prism.server.net.ClientLink0;

public class Doorman implements IDoorman, ILoopListener, IClient0Handler
{
	private volatile List<ClientLink0> links;

	public Doorman()
	{
		links = new ArrayList<ClientLink0>();
	}

	@Override
	public synchronized void update()
	{
		for (int i = links.size() - 1; i >= 0; --i)
			handleClient(i);
	}

	private void handleClient(int index)
	{
		ClientLink0 client0 = links.get(index);
		client0.update();
		int ms = client0.getClock().getTimeMs();
		boolean isLoggedIn = false;
		Exception e = client0.getCore().getCrashException();

		if (e != null)
		{
			kick = true;
		}
		else if (isLoggedIn)
		{

		}
		else if (ms >= 3000)
		{
			kick = true;
		}

		if (ms > 3000)
		{
			client0.suppressCrashWarning();
			client0.kick();
			links.remove(client0);
			System.err.println("doorman kicked " + client0 + " for inactivity (" + ms + " ms)");
		}
	}

	//	private void test(Socket socket)
	//	{
	//		try
	//		{
	//			InputStreamReader in = new InputStreamReader(socket.getInputStream());
	//			char[] buffer = new char[200];
	//			do
	//			{
	//				int n = in.read(buffer, 0, 200); // blockiert bis Nachricht empfangen
	//				String s = new String(buffer, 0, n);
	//
	//				System.out.println("message received - length: " + n + " - string: " + s);
	//			}
	//			while (true);
	//		}
	//		catch (Exception e0)
	//		{
	//			e0.printStackTrace();
	//		}
	//	}

	@Override
	public synchronized void passClient(ClientCore client)
	{
		ClientLink0 c = new ClientLink0(client, this);
		links.add(c);
	}

	@Override
	public void login(ClientLink0 client0, IText_r acc, byte[] pw, List<Integer> versions)
	{
		System.out.println("client " + client0.toString() + " is logging in: acc=" + acc.toString());
	}

	@Override
	public void clientCrashed(ClientLink0 client0, Exception e)
	{
		String s;
		if (e instanceof PrismException)
			s = ((PrismException) e).code.getText();
		else if (e != null)
			s = e.getMessage();
		else
			s = null;

		client0.suppressCrashWarning();
		client0.kick();
		links.remove(client0);

		System.err.println("doorman watched client " + client0.toString() + " crash" + (s == null ? "" : " (" + s + ")"));
	}

	@Override
	public void receivedUnexpectedMessage(ClientLink0 client0, Message m)
	{
		client0.kick();
		links.remove(client0);

		System.err.println("doorman kicked client " + client0.toString() + " due to unexpected message (" + m + ")");
	}
}
