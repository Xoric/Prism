package xoric.prism.creator.drawer.control;

import java.io.File;
import java.util.List;

import xoric.prism.creator.drawer.model.AnimationModel;
import xoric.prism.creator.drawer.model.DrawerModel;
import xoric.prism.creator.drawer.view.IDrawerView;
import xoric.prism.data.types.IPoint_r;
import xoric.prism.data.types.IText_r;
import xoric.prism.world.entities.AnimationIndex;
import xoric.prism.world.entities.ViewAngle;

public class DrawerControl implements IDrawerControl, IBusyControl
{
	private IDrawerView view;
	private DrawerModel model;

	private ModelControl modelControl;
	private AnimationControl animationControl;
	private SpriteControl spriteControl;

	public DrawerControl(IDrawerView view)
	{
		this.view = view;
		//		this.model = new DrawerModel();

		modelControl = new ModelControl(model, this);
		animationControl = new AnimationControl(model, this);
		spriteControl = new SpriteControl(model, this);

		acceptModel(null, true);
	}

	@Override
	public void setBusy(boolean b)
	{
		view.setHourglass(b);
	}

	private void acceptModel(DrawerModel m, boolean acceptNull)
	{
		if (m != null || acceptNull)
		{
			model = m;

			view.setModel(m);
			modelControl.setModel(m);
			animationControl.setModel(m);
			spriteControl.setModel(m);

			view.displayAll(m);
		}
	}

	/* *********** model control ****************** */

	@Override
	public void requestNewModel()
	{
		acceptModel(modelControl.createNewModel(), false);
	}

	@Override
	public void requestOpenModel()
	{
		acceptModel(modelControl.openModel(), false);
	}

	@Override
	public void requestCloseModel()
	{
		if (modelControl.closeModel())
			acceptModel(null, true);
	}

	@Override
	public void requestSetName(IText_r name)
	{
		modelControl.setName(name);
		view.displayName(name);
	}

	@Override
	public void requestResizeSprites(IPoint_r spriteSize)
	{
		boolean b = modelControl.askChangeSpriteSize(spriteSize);

		if (b)
		{
			// apply changes to model
			modelControl.setSpriteSize(spriteSize);

			// resize sprites
			spriteControl.resizeAllSprites(model.getPath(), spriteSize);

			// update displays
			view.displaySpriteSize(spriteSize);
			view.updateCurrentAnimation();
		}
	}

	@Override
	public void requestGenerateAnimations()
	{
		modelControl.generateAnimations(model);
	}

	@Override
	public void requestExportModel()
	{
		modelControl.exportModel(model);
	}

	@Override
	public void requestCreateNewPortrait()
	{
		// TODO Auto-generated method stub

	}

	@Override
	public void requestImportPortrait()
	{
		// TODO Auto-generated method stub

	}

	@Override
	public void requestEditPortrait()
	{
		// TODO Auto-generated method stub

	}

	@Override
	public void requestDeletePortrait()
	{
		// TODO Auto-generated method stub

	}

	/* *********** animation control ****************** */

	@Override
	public void requestAddAnimation(AnimationIndex a)
	{
		AnimationModel m = model.getAnimation(a);
		m.unlock();
		view.displayAnimationInList(m);
	}

	@Override
	public void requestDeleteAnimation(AnimationIndex a)
	{
		System.out.println("requestDeleteAnimation(" + a + ")");

		//		view.displayAnimation(animation, false);
	}

	/* *********** sprite control ****************** */

	@Override
	public void requestCloneSprite(AnimationIndex a, ViewAngle v, int index)
	{
		// add a sprite
		spriteControl.cloneSprite(a, v, index);

		// reload animation list and sprites
		AnimationModel m = model.getAnimation(a);
		m.load();
		view.displayAnimationInList(m);
		view.updateCurrentAnimation();
	}

	@Override
	public void requestInsertSprite(AnimationIndex a, ViewAngle v, int index)
	{
		// add a sprite
		spriteControl.insertSprite(a, v, index);

		// reload animation list and sprites
		AnimationModel m = model.getAnimation(a);
		m.load();
		view.displayAnimationInList(m);
		view.updateCurrentAnimation();
	}

	@Override
	public void requestInsertSpriteFromClipboard(AnimationIndex a, ViewAngle v, int index)
	{
		// insert sprite
		spriteControl.insertSpriteFromClipboard(a, v, index);

		// reload animation list and sprites
		AnimationModel m = model.getAnimation(a);
		m.load();
		view.displayAnimationInList(m);
		view.updateCurrentAnimation();
	}

	@Override
	public void requestCopySpriteToClipboard(AnimationIndex a, ViewAngle v, int index)
	{
		// copy sprite image to clipboard
		spriteControl.copySpriteToClipboard(model.getPath(), a, v, index);
	}

	@Override
	public void requestDeleteSprites(AnimationIndex a, ViewAngle v, List<Integer> indices)
	{
		// delete sprites
		spriteControl.deleteSprites(a, v, indices);

		// reload animation list and sprites
		AnimationModel m = model.getAnimation(a);
		m.load();
		view.displayAnimationInList(m);
		view.updateCurrentAnimation();
	}

	@Override
	public void requestEditSprite(File file)
	{
		spriteControl.editSprite(file);
	}

	@Override
	public void requestMakeSpritesTransparent(AnimationIndex a, ViewAngle v, List<Integer> indices)
	{
		spriteControl.makeSpritesTransparent(a, v, indices);

		// reload animation sprites
		view.updateCurrentAnimation();
	}

	@Override
	public void requestInputExternalImageEditor()
	{
		spriteControl.inputExternalImageEditor();
	}
}
