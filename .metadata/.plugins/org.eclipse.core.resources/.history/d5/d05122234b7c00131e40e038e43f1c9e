package xoric.prism.creator.drawer.generator;

import java.io.File;
import java.io.FileInputStream;
import java.util.ArrayList;
import java.util.List;

import javax.swing.JOptionPane;

import xoric.prism.creator.drawer.model.DrawerModel;
import xoric.prism.data.exceptions.PrismException;
import xoric.prism.data.meta.MetaBlock;
import xoric.prism.data.meta.MetaKey;
import xoric.prism.data.meta.MetaLine;
import xoric.prism.data.meta.MetaList;
import xoric.prism.data.meta.MetaType;
import xoric.prism.data.tools.Common;
import xoric.prism.data.types.IPath_r;
import xoric.prism.data.types.Text;
import xoric.prism.develop.meta.MetaFileCreator;
import xoric.prism.world.entities.AnimationIndex;

public class ModelGenerator
{
	private final DrawerModel model;

	public ModelGenerator(DrawerModel model)
	{
		this.model = model;
	}

	public void generateModel(String targetFilename)
	{
		try
		{
			List<AnimationIndex> animations = tryGenerate(targetFilename);
			StringBuilder sb = new StringBuilder();

			sb.append("<html>The following animations have been generated:<br>");
			for (File f : files)
			{
				long s = f.length();
				sb.append("<br><code>" + f.getName() + "</code> - " + Common.getFileSize(s));
			}
			sb.append("</html>");

			JOptionPane.showMessageDialog(null, sb.toString(), "Generate animations", JOptionPane.INFORMATION_MESSAGE);
		}
		catch (PrismException e)
		{
			e.code.print();
			e.user.showMessage();
		}
	}

	private List<AnimationIndex> tryGenerate(String targetFilename) throws PrismException
	{
		// create required MetaBlocks
		IPath_r path = model.getPath();
		MetaBlock devBlock = new MetaBlock(MetaType.DEVELOP, 0);
		MetaBlock modelBlock = new MetaBlock(MetaType.MODEL, 0);

		// keep track of all added animations
		List<AnimationIndex> animations = new ArrayList<AnimationIndex>();

		// add all available animations
		for (AnimationIndex a : AnimationIndex.values())
		{
			addAnimation(path, a, devBlock, modelBlock);
			animations.add(a);
		}

		// cancel if no animations were found
		if (animations.size() == 0)
		{
			PrismException e = new PrismException();
			e.setText("No animations could be found. Make sure to generate the model's animations in advance.");
			throw e;
		}

		// add target file
		MetaLine targetLine = new MetaLine(MetaKey.TARGET);
		targetLine.getHeap().texts.add(new Text(targetFilename));
		devBlock.addMetaLine(targetLine);

		// create MetaList
		MetaList metaList = new MetaList();
		metaList.addMetaBlock(modelBlock);
		metaList.addMetaBlock(devBlock);

		// pass information to MetaFileCreator
		MetaFileCreator c = new MetaFileCreator(path, path);
		c.infuseMetaList(metaList);
		c.create();

		// return added animations
		return animations;
	}

	private void addAnimation(IPath_r path, AnimationIndex a, MetaBlock devBlock, MetaBlock modelBlock) throws PrismException
	{
		// generate filenames
		String filename = a.toString().toLowerCase() + ".png";
		File file = path.getFile(filename);

		if (file.exists())
		{
			// load animation meta
			AnimationMeta meta = loadAnimationMeta(path, a);
			for (int i = 0; i < meta.getCount(); ++i)
			{
				MetaLine angleLine = new MetaLine(MetaKey.ITEM);
				angleLine.getHeap().ints.add(meta.getAngle(i).ordinal());
				angleLine.getHeap().ints.add(meta.getColumnCount(i));
				modelBlock.addMetaLine(angleLine);
			}

			// load animation image
			MetaLine attachLine = new MetaLine(MetaKey.ATTACH);
			attachLine.getHeap().texts.add(new Text(filename));
			devBlock.addMetaLine(attachLine);
		}
	}

	private AnimationMeta loadAnimationMeta(IPath_r path, AnimationIndex a) throws PrismException
	{
		AnimationMeta meta = null;
		String filename = a.toString().toLowerCase() + ".meta";
		try
		{
			File file = path.getFile(filename);

			meta = new AnimationMeta();
			FileInputStream stream = new FileInputStream(file);
			meta.unpack(stream);
			stream.close();
		}
		catch (Exception e0)
		{
			PrismException e = new PrismException(e0);
			e.setText("There was a problem while trying to load the meta file for an animation.");
			e.addInfo("animation", a.toString());
			e.addInfo("meta file", filename);
			throw e;
		}
		return meta;
	}
}
