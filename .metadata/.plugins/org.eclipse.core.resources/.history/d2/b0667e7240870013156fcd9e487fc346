package xoric.prism.creator.custom.view;

import java.awt.Color;
import java.awt.Graphics;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;

import javax.imageio.ImageIO;
import javax.swing.DefaultListModel;
import javax.swing.ImageIcon;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JSlider;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;

import xoric.prism.creator.common.spritelist.control.SpriteNameGenerator;
import xoric.prism.creator.custom.model.ObjectModel;
import xoric.prism.data.types.Rect;
import xoric.prism.swing.PrismSwing;

public class RectView extends JPanel implements IRectView, ListSelectionListener, ChangeListener, MouseListener, MouseMotionListener
{
	private static final long serialVersionUID = 1L;

	private ObjectModel model;

	private final JLabel imageLabel;
	private boolean isMouseDown;

	private BufferedImage image;
	private BufferedImage decoratedImage;
	private JSlider slider;

	private JList<String> rectList;

	public RectView()
	{
		super(new GridBagLayout());

		imageLabel = new JLabel();
		imageLabel.addMouseListener(this);
		imageLabel.addMouseMotionListener(this);
		imageLabel.setOpaque(true);
		imageLabel.setBackground(Color.red);
		JPanel p = new JPanel();
		p.add(imageLabel);
		JScrollPane scroll = PrismSwing.createScrollPane(p);

		rectList = new JList<String>();
		JScrollPane scroll2 = PrismSwing.createScrollPane(rectList);

		slider = new JSlider();
		slider.setMinimum(1);
		slider.setMaximum(10);
		slider.addChangeListener(this);

		GridBagConstraints c = new GridBagConstraints(0, 0, 1, 2, 0.3, 1.0, GridBagConstraints.CENTER, GridBagConstraints.BOTH, new Insets(
				0, 0, 0, 15), 0, 0);
		add(scroll2, c);

		c = new GridBagConstraints(1, 0, 1, 1, 0.7, 1.0, GridBagConstraints.CENTER, GridBagConstraints.BOTH, new Insets(0, 0, 0, 0), 0, 0);
		add(scroll, c);

		c.weighty = 0.0;
		c.gridy = 1;
		add(slider, c);
	}

	@Override
	public void setEnabled(boolean b)
	{
		super.setEnabled(b);
		slider.setEnabled(image != null && b);
	}

	private void decorateImage()
	{
		decoratedImage = deepCopy();

		int index = rectList.getSelectedIndex();
		if (index >= 0 && index < rectList.getModel().getSize())
		{
			Rect r = model.getRect(index);
			int rgb = Color.orange.getRGB();

			if (r.getWidth() > 0 && r.getHeight() > 0)
			{
				int zoom = slider.getValue();

				int sx = r.getX() * zoom;
				int sy = r.getY() * zoom;
				int w = r.getWidth() * zoom;
				int h = r.getHeight() * zoom;
				int sx2 = sx + w + zoom;
				int sy2 = sy + h + zoom;

				for (int x = sx; x < sx + w + zoom; ++x)
				{
					decoratedImage.setRGB(x, sy, rgb);
					decoratedImage.setRGB(x, sy2, rgb);
				}
				for (int y = sy; y < sy + h + zoom; ++y)
				{
					decoratedImage.setRGB(sx, y, rgb);
					decoratedImage.setRGB(sx2, y, rgb);
				}
			}
		}
	}

	private void updateImage()
	{
		decorateImage();
		ImageIcon icon = new ImageIcon(decoratedImage);
		imageLabel.setIcon(icon);
	}

	private void updateListCaptions()
	{
		if (model != null && rectList.getModel() instanceof DefaultListModel)
		{
			DefaultListModel<String> m = (DefaultListModel<String>) rectList.getModel();

			for (int i = 0; i < model.getRectCount(); ++i)
				m.set(i, "Rect " + i + ": " + model.getRect(i).toString());
		}
	}

	private BufferedImage deepCopy()
	{
		int zoom = slider.getValue();
		int w = image.getWidth() * zoom;
		int h = image.getHeight() * zoom;

		BufferedImage b = new BufferedImage(w, h, BufferedImage.TYPE_INT_ARGB);
		Graphics g = b.getGraphics();
		g.drawImage(image, 0, 0, w, h, null);
		g.dispose();
		return b;
	}

	private void loadImage(File file)
	{
		try
		{
			image = ImageIO.read(file);
			slider.setEnabled(true);
		}
		catch (IOException e)
		{
			image = null;
			slider.setEnabled(false);
		}
	}

	@Override
	public void displayObject(ObjectModel model, SpriteNameGenerator spriteNameGenerator)
	{
		this.model = model;
		this.loadImage(spriteNameGenerator.getFile(0));

		model.addRect(new Rect(0, 0, 10, 8));

		DefaultListModel<String> m = new DefaultListModel<String>();

		if (model != null)
			for (int i = 0; i < model.getRectCount(); ++i)
				m.addElement("");

		rectList.setModel(m);
		rectList.setSelectedIndex(0);

		updateImage();
		updateListCaptions();
	}

	@Override
	public void valueChanged(ListSelectionEvent e)
	{
		if (e.getValueIsAdjusting())
			updateImage();
	}

	@Override
	public void clear()
	{
		DefaultListModel<String> m = new DefaultListModel<String>();
		rectList.setModel(m);
		imageLabel.setIcon(null);
		imageLabel.revalidate();
	}

	@Override
	public void stateChanged(ChangeEvent e)
	{
		if (e.getSource() == slider)
			updateImage();
	}

	@Override
	public void mouseClicked(MouseEvent arg0)
	{
	}

	@Override
	public void mouseEntered(MouseEvent arg0)
	{
	}

	@Override
	public void mouseExited(MouseEvent arg0)
	{
	}

	@Override
	public void mousePressed(MouseEvent e)
	{
		isMouseDown = true;

		if (e.getButton() == MouseEvent.BUTTON1)
		{
			int index = rectList.getSelectedIndex();

			if (index >= 0 && index < rectList.getModel().getSize())
			{
				Rect r = model.getRect(index);
				int zoom = slider.getValue();
				int x = e.getX() / zoom;
				int y = e.getY() / zoom;

				if (x != r.getX() || y != r.getY())
				{
					int dx = x - r.getX();
					int dy = y - r.getY();
					r.setPosition(x, y);

					int w = r.getWidth() - dx;
					int h = r.getHeight() - dy;
					if (w < 0)
						w = 0;
					if (h < 0)
						h = 0;
					r.setSize(w, h);

					updateImage();
					updateListCaptions();
				}
			}
		}
	}

	@Override
	public void mouseReleased(MouseEvent arg0)
	{
		isMouseDown = false;
	}

	@Override
	public void mouseDragged(MouseEvent e)
	{
		if (isMouseDown)
		{
			int index = rectList.getSelectedIndex();

			if (index >= 0 && index < rectList.getModel().getSize())
			{
				Rect r = model.getRect(index);
				int zoom = slider.getValue();

				int x = e.getX() / zoom;
				int y = e.getY() / zoom ;

				int w = x - r.getX();
				int h = y - r.getY();

				if (w < 0)
					w = 0;
				else if (r.getX() + w > image.getWidth())
					w = image.getWidth() - r.getX();

				if (h < 0)
					h = 0;
				else if (r.getY() + h > image.getHeight())
					h = image.getHeight() - r.getY();

				if (w != r.getWidth() || h != r.getHeight())
				{
					r.setSize(w, h);

					updateImage();
					updateListCaptions();
				}
			}
		}
	}

	@Override
	public void mouseMoved(MouseEvent e)
	{
	}
}
