package xoric.prism.creator.custom.creators;

import java.awt.image.BufferedImage;
import java.util.List;

import xoric.prism.data.types.IPoint_r;
import xoric.prism.data.types.Point;
import xoric.prism.data.types.Rect;

import com.ryanm.droid.rugl.util.RectanglePacker;

class OptimizerThread extends Thread implements IOptimizerResults
{
	private final List<ObjectImages> objects;
	private final IOptimizer listener;
	private final IPoint_r originalSize;
	private volatile Point actualSize;

	public OptimizerThread(List<ObjectImages> objects, IPoint_r size, IOptimizer listener)
	{
		this.objects = objects;
		this.originalSize = new Point(size);
		this.listener = listener;
	}

	@Override
	public void run()
	{
		RectanglePacker<BufferedImage> p = new RectanglePacker<BufferedImage>(originalSize.getX(), originalSize.getY(), 0);

		for (ObjectImages o : objects)
			for (BufferedImage bi : o.getImages())
				p.insert(bi.getWidth(), bi.getHeight(), bi);

		int maxWidth = 0;
		int maxHeight = 0;

		for (ObjectImages o : objects)
		{
			for (BufferedImage bi : o.getImages())
			{
				Rect r = p.findRectangle(bi);

				if (r != null)
				{
					int x2 = r.calcX2();
					int y2 = r.calcY2();

					if (x2 > maxWidth)
						maxWidth = x2;
					if (y2 > maxWidth)
						maxHeight = y2;
				}
				else
					return;
			}
		}
		actualSize = new Point(maxWidth, maxHeight);

		if (listener != null)
			listener.onThreadFinished(this);
	}

	@Override
	public boolean wasSuccessful()
	{
		return actualSize != null;
	}

	@Override
	public IPoint_r getOriginalSize()
	{
		return originalSize;
	}

	@Override
	public Point getActualSize()
	{
		return actualSize;
	}
}
